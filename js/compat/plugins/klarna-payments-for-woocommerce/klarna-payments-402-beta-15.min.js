jQuery(function(i){var c={authorization_response:{},iframe_loaded:!1,show_form:!1,klarna_container_selector:"#klarna_container_2",checkout_values:{},addresses:{},check_changes:function(){i(".woocommerce-billing-fields input, .woocommerce-billing-fields select, .woocommerce-shipping-fields input, .woocommerce-shipping-fields select").each(function(){var e=i(this).attr("name"),a=i(this).val();c.checkout_values[e]!==a&&(c.checkout_values[e]=a,i(this).trigger("change"))})},debounce_changes:function(r,t,o){var s;return function(){var e=this,a=arguments,n=o&&!s;clearTimeout(s),s=setTimeout(function(){s=null,o||r.apply(e,a)},t),n&&r.apply(e,a)}},start:function(){i(document).ready(function(){i("#customer_details input, #customer_details select").each(function(){var e=i(this).attr("name"),a=i(this).val();c.checkout_values[e]=a}),c.isKlarnaPaymentsSelected()&&(c.initKlarnaCredit(),c.load().then(c.loadHandler))}),i("body").on("updated_checkout",function(){var e=i(".woocommerce-checkout-payment"),a=e.data();e.length&&1===a["blockUI.isBlocked"]&&e.unblock(),c.maybeHideShippingAddress(),c.isKlarnaPaymentsSelected()&&(c.initKlarnaCredit(),c.load().then(c.loadHandler))}),i(document.body).on("checkout_error",function(){i('input[name="klarna_payments_authorization_token"]').remove()}),i("form.checkout").on("keyup","#billing_phone",c.debounce_changes(function(){c.isKlarnaPaymentsSelected()&&4<i(this).val().length&&(c.initKlarnaCredit(),c.load().then(c.loadHandler))},750)),i("form.checkout").on("keyup","#billing_email",c.debounce_changes(function(){!c.isKlarnaPaymentsSelected()||i(this).parent().hasClass("woocommerce-invalid")||(c.initKlarnaCredit(),c.load().then(c.loadHandler))},750)),i("form.checkout").on("keyup","#billing_company",c.debounce_changes(function(){c.isKlarnaPaymentsSelected()&&(c.initKlarnaCredit(),c.load().then(c.loadHandler))},750)),i("body").on("change",'input[name="payment_method"]',function(){c.isKlarnaPaymentsSelected()&&(c.initKlarnaCredit(),c.load().then(c.loadHandler),c.collapseGateways()),c.isKlarnaPaymentsSelected()||i("#place_order").attr("disabled",!1),c.maybeHideShippingAddress()})},load:function(){var r,t,o,s=i.Deferred();return i("form.checkout").hasClass("processing")?s.reject():(r="#"+c.getSelectorContainerID(),console.log(r),r?(t=setInterval(function(){var e,a,n=!1;try{n=window.Klarna}catch(e){console.debug(e)}n&&n.Payments&&(clearInterval(t),clearTimeout(o),e={container:r,payment_method_category:"klarna_payments"===c.getSelectedPaymentCategory()?"":c.getSelectedPaymentCategory()},"US"===i("#billing_country").val()?(a=c.get_address_from_checkout_form(),n.Payments.load(e,a,function(e){s.resolve(e)})):n.Payments.load(e,function(e){s.resolve(e)}))},100),o=setTimeout(function(){clearInterval(t),s.reject()},3e3),s.promise()):void 0)},loadHandler:function(e){c.iframe_loaded=!0,e.show_form&&(c.show_form=!0)},isKlarnaPaymentsSelected:function(){return!!i('input[name="payment_method"]:checked').length&&-1!==i('input[name="payment_method"]:checked').val().indexOf("klarna_payments")},isTermsAccepted:function(){return!(i("#terms").length&&!i("#terms").is(":checked"))},setRadioButtonValues:function(){i('input[name="payment_method"]').each(function(){-1!==i(this).val().indexOf("klarna_payments")&&i(this).val("klarna_payments")})},getSelectorContainerID:function(){return i('input[name="payment_method"]:checked').attr("id").replace("payment_method_","")+"_container"},getSelectedPaymentCategory:function(){var e=i('input[name="payment_method"]:checked').attr("id").replace("payment_method_","");return console.log(e),e.replace("klarna_payments_","")},authorize:function(){var a=i.Deferred(),e=c.get_address();c.authorization_response={};try{Klarna.Payments.authorize(e,{payment_method_category:"klarna_payments"===c.getSelectedPaymentCategory()?"":c.getSelectedPaymentCategory()},function(e){c.authorization_response=e,a.resolve(e)})}catch(e){console.log(e)}return a.promise()},get_address:function(){var e={billing_address:{given_name:c.addresses.billing.given_name,family_name:c.addresses.billing.family_name,email:c.addresses.billing.email,phone:c.addresses.billing.phone,country:c.addresses.billing.country,region:c.addresses.billing.region,postal_code:c.addresses.billing.postal_code,city:c.addresses.billing.city,street_address:c.addresses.billing.street_address,street_address2:c.addresses.billing.street_address2,organization_name:"b2b"===klarna_payments_params.customer_type?c.addresses.billing.organization_name:""},shipping_address:{}};return e.shipping_address=i.extend({},e.billing_address),i("#ship-to-different-address").find("input").is(":checked")&&(e.shipping_address.given_name=c.addresses.shipping.given_name,e.shipping_address.family_name=c.addresses.shipping.family_name,e.shipping_address.country=c.addresses.shipping.country,e.shipping_address.region=c.addresses.shipping.region,e.shipping_address.postal_code=c.addresses.shipping.postal_code,e.shipping_address.city=c.addresses.shipping.city,e.shipping_address.street_address=c.addresses.shipping.street_address,e.shipping_address.street_address2=c.addresses.shipping.street_address2),e},get_address_from_checkout_form:function(){var e={billing_address:{given_name:c.checkout_values.billing_first_name,family_name:c.checkout_values.billing_last_name,email:c.checkout_values.billing_email,phone:c.checkout_values.billing_phone,country:c.checkout_values.billing_country,region:c.checkout_values.billing_state,postal_code:c.checkout_values.billing_postcode,city:c.checkout_values.billing_city,street_address:c.checkout_values.billing_address_1,street_address2:c.checkout_values.billing_address_2,organization_name:"b2b"===klarna_payments_params.customer_type?c.checkout_values.billing_company:""},shipping_address:{}};return e.shipping_address=i.extend({},e.billing_address),i("#ship-to-different-address").find("input").is(":checked")&&(e.shipping_address.given_name=c.checkout_values.shipping_first_name,e.shipping_address.family_name=c.checkout_values.shipping_last_name,e.shipping_address.country=c.checkout_values.shipping_country,e.shipping_address.region=c.checkout_values.shipping_state,e.shipping_address.postal_code=c.checkout_values.shipping_postcode,e.shipping_address.city=c.checkout_values.shipping_city,e.shipping_address.street_address=c.checkout_values.shipping_address_1,e.shipping_address.street_address2=c.checkout_values.shipping_address_2),e},collapseGateways:function(){i('input[name="payment_method"]').each(function(){i(this).is(":checked")?i(this).siblings("div.payment_box").show():i(this).siblings("div.payment_box").hide()})},maybeHideShippingAddress:function(){!1!==c.isKlarnaPaymentsSelected()?"b2b"===klarna_payments_params.customer_type&&jQuery("#customer_details .col-2").hide():jQuery("#customer_details .col-2").show()},initKlarnaCredit:function(e){e=c.getClientToken();window.klarnaInitData={client_token:e},Klarna.Payments.init(klarnaInitData)},printErrorMessage:function(e){i("#klarna-payments-error-notice").remove();var a=1==klarna_payments_params.pay_for_order,a=i(a?"div.woocommerce-notices-wrapper":"form.checkout");a.prepend('<div id="klarna-payments-error-notice" class="woocommerce-NoticeGroup"><ul class="woocommerce-error" role="alert"><li>'+e+"</li></ul></div>"),i.scroll_to_notices(a)},authorizeKlarnaOrder:function(a,n){c.authorize().done(function(e){"authorization_token"in e?(i("body").trigger("kp_auth_success"),i.ajax(klarna_payments_params.place_order_url,{type:"POST",dataType:"json",async:!0,data:{order_key:n,order_id:a,auth_token:c.authorization_response.authorization_token,nonce:klarna_payments_params.place_order_nonce},success:function(e){console.log("kp_place_order success"),console.log(e)},error:function(e){console.log("kp_place_order error"),console.log(e)},complete:function(e){!0===e.responseJSON.success?window.location.href=e.responseJSON.data:(i("form.checkout").removeClass("processing").unblock(),i("form.checkout").find(".input-text, select, input:checkbox").trigger("validate").blur(),i("form.checkout").trigger("update_checkout"))}})):(i("body").trigger("kp_auth_failed"),i("body").trigger("updated_checkout"),i("form.checkout").removeClass("processing"),i("form.checkout").unblock(),console.log("No authorization_token in response"),i("form.woocommerce-checkout").removeClass("processing").unblock(),i.ajax(klarna_payments_params.auth_failed_url,{type:"POST",dataType:"json",async:!0,data:{show_form:e.show_form,order_key:n,order_id:a,nonce:klarna_payments_params.auth_failed_nonce}}))})},klarnaPayForOrder:function(e){c.isKlarnaPaymentsSelected()&&(e.preventDefault(),c.isTermsAccepted()?(c.addresses=klarna_payments_params.addresses,c.authorizeKlarnaOrder(klarna_payments_params.order_id,klarna_payments_params.order_key)):c.printErrorMessage(klarna_payments_params.i18n.terms_not_checked))},getClientToken:function(){return 0<i("#kp_client_token").length?i("#kp_client_token").val():klarna_payments_params.client_token},orderSubmit:function(e){if(c.isKlarnaPaymentsSelected()){if(e.preventDefault(),i("form.checkout").is(".processing"))return!1;i("form.checkout").addClass("processing"),i("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),i.ajax({type:"POST",url:klarna_payments_params.submit_order,data:i("form.checkout").serialize(),dataType:"json",success:function(a){try{if("success"!==a.result)throw"Result failed";c.logToFile("Successfully placed order. Starting authorization with Klarna"),c.addresses=a.addresses,c.authorizeKlarnaOrder(a.order_id,a.order_key)}catch(e){a.messages?(c.logToFile("Checkout error | "+a.messages),c.failOrder("submission",a.messages)):(c.logToFile("Checkout error | "+e),c.failOrder("submission",'<div class="woocommerce-error">Checkout error</div>'))}},error:function(e){try{c.logToFile("AJAX error | "+JSON.stringify(e))}catch(e){c.logToFile("AJAX error | Failed to parse error message.")}c.failOrder("ajax-error",'<div class="woocommerce-error">Internal Server Error</div>')}})}},failOrder:function(e,a){i("body").trigger("updated_checkout"),i("form.checkout").removeClass("processing"),i("form.checkout").unblock(),i(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),i("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+a+"</div>"),i("form.checkout").removeClass("processing").unblock(),i("form.checkout").find(".input-text, select, input:checkbox").trigger("validate").blur(),i(document.body).trigger("checkout_error",[a]),i.scroll_to_notices(i("form.checkout"))},logToFile:function(e){i.ajax({url:klarna_payments_params.log_to_file_url,type:"POST",dataType:"json",data:{message:e,nonce:klarna_payments_params.log_to_file_nonce}})}};c.start(),i("body").ready(function(){c.setRadioButtonValues()}),i("body").ajaxComplete(function(){c.setRadioButtonValues()}),i("body").on("click","input#place_order, button#place_order, .fc-place-order-button",function(e){1==klarna_payments_params.pay_for_order?c.klarnaPayForOrder(e):c.orderSubmit(e)})});