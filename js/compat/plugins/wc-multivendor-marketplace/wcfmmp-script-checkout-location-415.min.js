jQuery(document).ready(function(m){var a=geocoder=marker=map_marker=infowindow="",e=null;function n(o,e,t,a){console.log("[fc][wcfmmp] bindDataToForm",{address:o,lat:e,lng:t,find_field_refresh:a}),a&&("google"==wcfm_maps.lib?document.getElementById("wcfmmp_user_location").value=o:(m("#wcfmmp_user_location").val(o),m("#leaflet_wcfmmp_user_location").find(".search-input").val(o)));var a=document.getElementById("wcfmmp_user_location_lat"),o=document.getElementById("wcfmmp_user_location_lng"),n=a.value,c=o.value;a.value=e,o.value=t,n!==String(e)||c!==String(t)?(console.log("[fc][wcfmmp] update_checkout (location changed)",{prevLat:n,prevLng:c}),m(document.body).trigger("update_checkout")):console.log("[fc][wcfmmp] skip update_checkout (location unchanged)",{prevLat:n,prevLng:c})}function c(o,e,t){google.maps.event.addListener(e,"click",function(){o.setContent(t),o.open(a,e)})}function i(){navigator.geolocation.getCurrentPosition(function(t){$current_location_fetched=!0,console.log(t.coords.latitude,t.coords.longitude),"google"==wcfm_maps.lib?geocoder.geocode({location:{lat:t.coords.latitude,lng:t.coords.longitude}},function(o,e){"OK"===e&&(n(o[0].formatted_address,t.coords.latitude,t.coords.longitude,!0),e=new google.maps.LatLng(t.coords.latitude,t.coords.longitude),marker.setPosition(e),marker.setVisible(!0),infowindow.setContent(o[0].formatted_address),infowindow.open(a,marker),c(infowindow,marker,o[0].formatted_address))}):m.get("https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat="+t.coords.latitude+"&lon="+t.coords.longitude,function(o){n(o.address.road,t.coords.latitude,t.coords.longitude,!0),map_marker.bindPopup(o.address.road).openPopup()})})}function t(){var e,o,t;console.log("[fc][wcfmmp] initializeCheckoutLocation"),"google"==wcfm_maps.lib?(m("#wcfmmp_user_location").parent().append('<i class="wcfmmmp_locate_icon" style="background-image: url('+wcfmmp_checkout_map_options.locate_svg+')"></i>'),t=new google.maps.LatLng(wcfmmp_checkout_map_options.default_lat,wcfmmp_checkout_map_options.default_lng,13),a=new google.maps.Map(document.getElementById("wcfmmp-user-locaton-map"),{center:t,mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:parseInt(wcfmmp_checkout_map_options.default_zoom)}),o={url:wcfmmp_checkout_map_options.store_icon,scaledSize:new google.maps.Size(wcfmmp_checkout_map_options.icon_width,wcfmmp_checkout_map_options.icon_height)},marker=new google.maps.Marker({map:a,position:t,animation:google.maps.Animation.DROP,icon:o,draggable:!0}),t=document.getElementById("wcfmmp_user_location"),geocoder=new google.maps.Geocoder,(e=new google.maps.places.Autocomplete(t)).bindTo("bounds",a),infowindow=new google.maps.InfoWindow,e.addListener("place_changed",function(){infowindow.close(),marker.setVisible(!1);var o=e.getPlace();o.geometry?(o.geometry.viewport?a.fitBounds(o.geometry.viewport):(a.setCenter(o.geometry.location),a.setZoom(parseInt(wcfmmp_checkout_map_options.default_zoom))),marker.setPosition(o.geometry.location),marker.setVisible(!0),n(o.formatted_address,o.geometry.location.lat(),o.geometry.location.lng(),!1),infowindow.setContent(o.formatted_address),infowindow.open(a,marker),c(infowindow,marker,o.formatted_address)):window.alert("Autocomplete returned place contains no geometry")}),google.maps.event.addListener(marker,"dragend",function(){geocoder.geocode({latLng:marker.getPosition()},function(o,e){e==google.maps.GeocoderStatus.OK&&o[0]&&(n(o[0].formatted_address,marker.getPosition().lat(),marker.getPosition().lng(),!0),infowindow.setContent(o[0].formatted_address),infowindow.open(a,marker),c(infowindow,marker,o[0].formatted_address))})})):(m("#wcfmmp_user_location").replaceWith('<div id="leaflet_wcfmmp_user_location"></div><input type="hidden" class="wcfm_custom_hide" name="wcfmmp_user_location" id="wcfmmp_user_location" />'),(map_marker=$wcfmmp_user_location_lat&&$wcfmmp_user_location_lng?((a=new L.Map("wcfmmp-user-locaton-map",{zoom:parseInt(wcfmmp_checkout_map_options.default_zoom),center:new L.latLng([$wcfmmp_user_location_lat,$wcfmmp_user_location_lng])})).addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),L.marker([$wcfmmp_user_location_lat,$wcfmmp_user_location_lng],{draggable:"true"}).addTo(a).on("click",function(){window.open("https://www.openstreetmap.org/?mlat="+$wcfmmp_user_location_lat+"&mlon="+$wcfmmp_user_location_lng+"#map=14/"+$wcfmmp_user_location_lat+"/"+$wcfmmp_user_location_lng,"_blank")})):((a=new L.Map("wcfmmp-user-locaton-map",{zoom:parseInt(wcfmmp_checkout_map_options.default_zoom),center:new L.latLng([wcfmmp_checkout_map_options.default_lat,wcfmmp_checkout_map_options.default_lng])})).addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),L.marker([0,0],{draggable:"true"}))).on("dragend",function(o){var e=map_marker.getLatLng(),t="http://nominatim.openstreetmap.org/reverse?format=json&lat="+e.lat+"&lon="+e.lng+"&zoom=18&addressdetails=1",a="";m.getJSON(t).done(function(o){o.address.road?a+=o.address.road+", ":o.address.pedestrian?a+=o.address.pedestrian+", ":a="",o.address.house_number&&(a+=o.address.house_number+", "),o.address.city_district&&(a+=o.address.city_district+", "),o.address.city&&(a+=o.address.city+", "),o.address.postcode&&(a+=o.address.postcode),n(a,e.lat,e.lng,!0);o=a;map_marker.bindPopup(o).openPopup()})}),o=new L.Control.Search({container:"leaflet_wcfmmp_user_location",url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],marker:map_marker,moveToLocation:function(o,e,t){n(e,o.lat,o.lng,!0),t.setView(o,parseInt(wcfmmp_checkout_map_options.default_zoom))},initial:!1,collapsed:!1,autoType:!1,minLength:2}),a.addControl(o),setTimeout(function(){a.invalidateSize()},3e3)),(t=m("#wcfmmp-user-locaton-map")).length&&(console.log("[fc][wcfmmp] markInitialized"),t.data("fcWcfmmpInitialized",!0)),navigator.geolocation&&(m(".wcfmmmp_locate_icon").on("click",function(){i()}),m("#wcfmmp_user_location_lat").val()&&m("#wcfmmp_user_location_lng").val()?console.log("[fc][wcfmmp] skip auto geolocation: coords already set"):(console.log("[fc][wcfmmp] auto geolocation: empty coords"),i()))}function o(){console.log("[fc][wcfmmp] maybeInitCheckoutLocation");var o=m("#wcfmmp-user-locaton-map");o.length?o.data("fcWcfmmpInitialized")?console.log("[fc][wcfmmp] skip init: already initialized"):0===m("#wcfmmp_user_location_lat").length?console.log("[fc][wcfmmp] skip init: lat field missing"):(e&&clearTimeout(e),e=setTimeout(function(){console.log("[fc][wcfmmp] init timeout fired"),t()},0)):console.log("[fc][wcfmmp] skip init: map container missing")}$wcfmmp_user_location_lat=jQuery("#wcfmmp_user_location_lat").val(),$wcfmmp_user_location_lng=jQuery("#wcfmmp_user_location_lng").val(),o(),m(document.body).on("updated_checkout",o)});