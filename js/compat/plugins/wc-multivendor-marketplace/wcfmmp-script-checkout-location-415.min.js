jQuery(function(d){var o=null;function t(){var n=geocoder=marker=map_marker=infowindow="",a=jQuery("#wcfmmp_user_location_lat").val(),m=jQuery("#wcfmmp_user_location_lng").val();function r(e,o,t,n){n&&("google"==wcfm_maps.lib?document.getElementById("wcfmmp_user_location").value=e:(d("#wcfmmp_user_location").val(e),d("#leaflet_wcfmmp_user_location").find(".search-input").val(e))),document.getElementById("wcfmmp_user_location_lat").value=o,document.getElementById("wcfmmp_user_location_lng").value=t,d(document.body).trigger("update_checkout")}function c(e,o,t){google.maps.event.addListener(o,"click",function(){e.setContent(t),e.open(n,o)})}function i(){navigator.geolocation.getCurrentPosition(function(t){$current_location_fetched=!0,console.log(t.coords.latitude,t.coords.longitude),"google"==wcfm_maps.lib?geocoder.geocode({location:{lat:t.coords.latitude,lng:t.coords.longitude}},function(e,o){"OK"===o&&(r(e[0].formatted_address,t.coords.latitude,t.coords.longitude,!0),o=new google.maps.LatLng(t.coords.latitude,t.coords.longitude),marker.setPosition(o),marker.setVisible(!0),infowindow.setContent(e[0].formatted_address),infowindow.open(n,marker),c(infowindow,marker,e[0].formatted_address))}):d.get("https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat="+t.coords.latitude+"&lon="+t.coords.longitude,function(e){r(e.address.road,t.coords.latitude,t.coords.longitude,!0),map_marker.bindPopup(e.address.road).openPopup()})})}0<jQuery("#wcfmmp_user_location_lat").length&&setTimeout(function(){var o,e,t;"undefined"!=typeof wcfm_maps&&"undefined"!=typeof wcfmmp_checkout_map_options&&("google"==wcfm_maps.lib?(t=d("#wcfmmp_user_location")).length&&"undefined"!=typeof google&&google.maps&&(t.parent().find(".wcfmmmp_locate_icon").remove(),t.parent().append('<i class="wcfmmmp_locate_icon" style="background-image: url('+wcfmmp_checkout_map_options.locate_svg+')"></i>'),t=new google.maps.LatLng(wcfmmp_checkout_map_options.default_lat,wcfmmp_checkout_map_options.default_lng,13),n=new google.maps.Map(document.getElementById("wcfmmp-user-locaton-map"),{center:t,mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:parseInt(wcfmmp_checkout_map_options.default_zoom)}),e={url:wcfmmp_checkout_map_options.store_icon,scaledSize:new google.maps.Size(wcfmmp_checkout_map_options.icon_width,wcfmmp_checkout_map_options.icon_height)},marker=new google.maps.Marker({map:n,position:t,animation:google.maps.Animation.DROP,icon:e,draggable:!0}),t=document.getElementById("wcfmmp_user_location"),geocoder=new google.maps.Geocoder,(o=new google.maps.places.Autocomplete(t)).bindTo("bounds",n),infowindow=new google.maps.InfoWindow,o.addListener("place_changed",function(){infowindow.close(),marker.setVisible(!1);var e=o.getPlace();e.geometry?(e.geometry.viewport?n.fitBounds(e.geometry.viewport):(n.setCenter(e.geometry.location),n.setZoom(parseInt(wcfmmp_checkout_map_options.default_zoom))),marker.setPosition(e.geometry.location),marker.setVisible(!0),r(e.formatted_address,e.geometry.location.lat(),e.geometry.location.lng(),!1),infowindow.setContent(e.formatted_address),infowindow.open(n,marker),c(infowindow,marker,e.formatted_address)):window.alert("Autocomplete returned place contains no geometry")}),google.maps.event.addListener(marker,"dragend",function(){geocoder.geocode({latLng:marker.getPosition()},function(e,o){o==google.maps.GeocoderStatus.OK&&e[0]&&(r(e[0].formatted_address,marker.getPosition().lat(),marker.getPosition().lng(),!0),infowindow.setContent(e[0].formatted_address),infowindow.open(n,marker),c(infowindow,marker,e[0].formatted_address))})})):"undefined"!=typeof L&&(0===d("#leaflet_wcfmmp_user_location").length&&d("#wcfmmp_user_location").replaceWith('<div id="leaflet_wcfmmp_user_location"></div><input type="hidden" class="wcfm_custom_hide" name="wcfmmp_user_location" id="wcfmmp_user_location" />'),(map_marker=a&&m?((n=new L.Map("wcfmmp-user-locaton-map",{zoom:parseInt(wcfmmp_checkout_map_options.default_zoom),center:new L.latLng([a,m])})).addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),L.marker([a,m],{draggable:"true"}).addTo(n).on("click",function(){window.open("https://www.openstreetmap.org/?mlat="+a+"&mlon="+m+"#map=14/"+a+"/"+m,"_blank")})):((n=new L.Map("wcfmmp-user-locaton-map",{zoom:parseInt(wcfmmp_checkout_map_options.default_zoom),center:new L.latLng([wcfmmp_checkout_map_options.default_lat,wcfmmp_checkout_map_options.default_lng])})).addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),L.marker([0,0],{draggable:"true"}))).on("dragend",function(e){var o=map_marker.getLatLng(),t="http://nominatim.openstreetmap.org/reverse?format=json&lat="+o.lat+"&lon="+o.lng+"&zoom=18&addressdetails=1",n="";d.getJSON(t).done(function(e){e.address.road?n+=e.address.road+", ":e.address.pedestrian?n+=e.address.pedestrian+", ":n="",e.address.house_number&&(n+=e.address.house_number+", "),e.address.city_district&&(n+=e.address.city_district+", "),e.address.city&&(n+=e.address.city+", "),e.address.postcode&&(n+=e.address.postcode),r(n,o.lat,o.lng,!0);e=n;map_marker.bindPopup(e).openPopup()})}),e=new L.Control.Search({container:"leaflet_wcfmmp_user_location",url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],marker:map_marker,moveToLocation:function(e,o,t){r(o,e.lat,e.lng,!0),t.setView(e,parseInt(wcfmmp_checkout_map_options.default_zoom))},initial:!1,collapsed:!1,autoType:!1,minLength:2}),n.addControl(e),setTimeout(function(){n.invalidateSize()},3e3))),(t=d("#wcfmmp-user-locaton-map")).length&&t.data("fcWcfmmpInitialized",!0),navigator.geolocation&&(d(document.body).off("click.fcWcfmmpLocate",".wcfmmmp_locate_icon").on("click.fcWcfmmpLocate",".wcfmmmp_locate_icon",function(){i()}),i())},1e3)}function e(){var e=d("#wcfmmp-user-locaton-map");e.length&&!e.data("fcWcfmmpInitialized")&&0!==d("#wcfmmp_user_location_lat").length&&(o&&clearTimeout(o),o=setTimeout(function(){t()},0))}e(),d(document.body).on("updated_checkout",e)});