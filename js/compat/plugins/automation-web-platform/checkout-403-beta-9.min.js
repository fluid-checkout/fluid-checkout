jQuery(document).ready(function(n){var t,a=5,c=5,s=n("#awp_resend_otp_btn"),i=n("#awp_resend_timer"),r=(n("#billing_phone_field"),n("#awp_otp_popup")),l=n("#user_phone_number"),p=(n("form.woocommerce-checkout"),n(".otp-input")),u=(n("#verification_message"),n("#billing_phone"));function d(){i.text(" ("+a+"s)")}function _(o,e){var e=e?"woocommerce-success":"woocommerce-error",t=u.next(".fc-wawp-message"),t=(0===t.length&&(t=n('<span class="fc-wawp-message"></span>'),u.after(t)),t.removeClass("woocommerce-success woocommerce-error").addClass(e).text(o).show(),r.find(".awp-popup-message"));0===t.length&&(t=n('<div class="awp-popup-message"></div>'),r.find(".awp-otp-content").prepend(t)),t.removeClass("custom-message-success custom-message-error").addClass(e).text(o).show()}async function f(o,e){try{(await n.post({url:otpAjax.ajaxurl,data:{action:"send_otp",phone_number:o,first_name:e,security:otpAjax.nonce}})).success?(console.log("OTP sent successfully"),_(awp_translations.otp_sent_success,!0),r.show(),s.prop("disabled",!0),d(),t=setInterval(function(){a--,d(),a<=0&&(clearInterval(t),s.prop("disabled",!1),i.text(""),a=c)},1e3)):(console.log("Failed to send OTP"),_(awp_translations.otp_sent_failure,!1))}catch(o){console.log("Error in sending OTP",o),_(awp_translations.otp_sent_failure,!1)}}async function h(){var o,e="";p.each(function(){e+=n(this).val()});try{if((await n.post({url:otpAjax.ajaxurl,dataType:"json",data:{action:"verify_otp",otp:e,security:otpAjax.nonce}})).success)return console.log("OTP verified successfully"),_(awp_translations.otp_verified_success,!0),r.hide(),n(document.body).trigger("update_checkout"),o=u.val(),otpAjax.isLoggedIn&&await n.post({url:otpAjax.ajaxurl,data:{action:"update_user_phone_number",phone_number:o,security:otpAjax.nonce}}),!0;console.log("Incorrect OTP"),_(awp_translations.otp_incorrect,!1)}catch(o){console.log("Error in verifying OTP",o),_(awp_translations.otp_incorrect,!1)}}function g(){p.val("").prop("disabled",!0).css({"background-color":"#cacaca",border:"#cacaca"}),p.first().prop("disabled",!1).css("background-color","white")}n(document).on("click","#fc-wawp-verify-button",async function(o){var e;r.is(":hidden")&&(o.preventDefault(),o=n("#billing_phone").val(),e=n("#billing_first_name").val(),g(),l.text(o),f(o,e),r.show(),p.first().focus())}),n(document).on("click",".awp-otp-popup-close",function(){r.hide(),g()}),p.on("input",function(){n(this).val().length===this.maxLength&&n(this).next(".otp-input").prop("disabled",!1).css("background-color","white").focus(),p.each(function(){""===n(this).val()?n(this).css({"background-color":"#cacaca",border:"#cacaca"}):n(this).css({"background-color":"white",border:"1px solid #ccc"})}),0===p.filter(function(){return""===n(this).val()}).length&&h()}),p.on("keydown",function(o){"Backspace"===o.key&&0===n(this).val().length&&n(this).prev(".otp-input").focus()}),p.on("paste",function(o){var e=o.originalEvent.clipboardData.getData("text");p.each(function(o){n(this).val(e[o]||"")}),0===p.filter(function(){return""===n(this).val()}).length&&h()}),n(document).on("click","#awp_verify_otp_btn",h),n(document).on("click","#awp_resend_otp_btn",function(){f(n("#billing_phone").val(),n("#billing_first_name").val()),a+=5,d()}),n(document).on("click","#awp_edit_phone_btn",function(){r.hide(),n("#billing_phone").focus()}),g()});