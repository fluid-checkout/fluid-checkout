{"version":3,"file":"../fc-fragments-refresh-316-beta-10.min.js","sources":["fc-fragments-refresh-316-beta-10.js"],"sourcesContent":["/**\n * Manage fragments refres update actions for other pages that don't use the default WooCommerce AJAX events.\n *\n * DEPENDS ON:\n * - jQuery // Interact with WooCommerce events\n */\n (function (root, factory) {\n\tif ( typeof define === 'function' && define.amd ) {\n\t\tdefine([], factory(root));\n\t} else if ( typeof exports === 'object' ) {\n\t\tmodule.exports = factory(root);\n\t} else {\n\t\troot.FCFragmentsRefresh = factory(root);\n\t}\n})(typeof global !== 'undefined' ? global : this.window || this.global, function (root) {\n\n\t'use strict';\n\n\tvar $ = jQuery;\n\tvar _hasJQuery = ( $ != null );\n\n\tvar _hasInitialized = false;\n\tvar _publicMethods = {};\n\tvar _settings = {\n\t\tbodyClass:                             'has-fc-fragments-refresh',\n\n\t\tdataFormSelector:                      'div.woocommerce form',\n\t\tsectionSelector:                       '.fc-section',\n\t\tmessagesWrapperSelector:               '.woocommerce-notices-wrapper',\n\t\tformRowSelector:                       '.form-row',\n\t\tupdateFieldsSelector:                  '.update_totals_on_change input.input-text, .update_totals_on_change select',\n\t\tloadingInputSelector:                  '.loading_indicator_on_change input.input-text',\n\n\t\tsectionVisibleStateFieldSelector:      '.fc-section-visible-state[type=\"hidden\"]',\n\t\tsectionVisibleStateAttribute:          'data-section-visible',\n\n\t\tloadingClass:                           'fc-loading',\n\t\tuiProcessingClass:                     'processing',\n\n\t\tupdateFragmentsNonce:                  '', // Value updated during runtime\n\t\tupdateWaitTime:                        500,\n\t}\n\tvar _xhr = false;\n\tvar _debouncedUpdateFragments;\n\tvar _fragments = {};\n\n\n\n\t/**\n\t * METHODS\n\t */\n\n\n\n\t/**\n\t * Get the offset position of the element recursively adding the offset position of parent elements until the `stopElement` (or the `body` element).\n\t *\n\t * @param   HTMLElement  element      Element to get the offset position for.\n\t * @param   HTMLElement  stopElement  Parent element where to stop adding the offset position to the total offset top position of the element.\n\t *\n\t * @return  int                       Offset position of the element until the `stopElement` or the `body` element.\n\t */\n\tvar getOffsetTop = function( element, stopElement ) {\n\t\tvar offsetTop = 0;\n\n\t\twhile( element ) {\n\t\t\t// Reached the stopElement\n\t\t\tif ( stopElement && stopElement == element ) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\toffsetTop += element.offsetTop;\n\t\t\telement = element.offsetParent;\n\t\t}\n\t\t\n\t\treturn offsetTop;\n\t}\n\n\n\n\n\t/**\n\t * Maybe change visibility status of cart sections.\n\t *\n\t * @param   Event  _event  An unused `jQuery.Event` object.\n\t * @param   Array  data   The updated checkout data.\n\t */\n\tvar maybeChangeSectionState = function( _event, data ) {\n\t\tvar sectionElements = document.querySelectorAll( _settings.sectionSelector );\n\t\tfor ( var i = 0; i < sectionElements.length; i++ ) {\n\t\t\tvar sectionElement = sectionElements[i];\n\n\t\t\t// Handle visibility state\n\t\t\tvar visibilityHiddenField = sectionElement.querySelector( _settings.sectionVisibleStateFieldSelector );\n\t\t\tif ( visibilityHiddenField && 'no' === visibilityHiddenField.value ) {\n\t\t\t\tsectionElement.setAttribute( _settings.sectionVisibleStateAttribute, visibilityHiddenField.value );\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsectionElement.removeAttribute( _settings.sectionVisibleStateAttribute );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Maybe enhance select fields with TomSelect.\n\t */\n\tvar maybeEnhanceFields = function() {\n\t\t// Bail if FCEnhancedSelect is not available\n\t\tif ( ! window.FCEnhancedSelect ) { return; }\n\n\t\tFCEnhancedSelect.enhanceFields();\n\t}\n\n\n\n\t// CHANGE: Maybe add loading class to the form row\n\tvar maybeSetLoadingIndicator = function ( e ) {\n\t\tif ( e.target && e.target.matches( _settings.loadingInputSelector ) ) {\n\t\t\tvar formRow = e.target.closest( _settings.formRowSelector );\n\t\t\tif ( formRow ) {\n\t\t\t\tformRow.classList.add( _settings.loadingClass );\n\t\t\t}\n\t\t}\n\t};\n\n\t// CHANGE: Add function to remove loading classes from elements after updating the checkout fragments\n\tvar maybeStopLoadingIndicators = function() {\n\t\tvar maybeLoadingFields = document.querySelectorAll( _settings.loadingInputSelector );\n\t\tfor ( var i = 0; i < maybeLoadingFields.length; i++ ) {\n\t\t\tvar input = maybeLoadingFields[ i ];\n\t\t\tvar formRow = input.closest( _settings.formRowSelector );\n\t\t\tif ( formRow ) {\n\t\t\t\tformRow.classList.remove( _settings.loadingClass );\n\t\t\t}\n\t\t}\n\t};\n\n\n\n\t/**\n\t * Update the cart fragments.\n\t * @throws  {TypeError}  Throws TypeError when used directly with event handlers because events pass the Event object as the first parameter while this function expects the first parameter to be the extra data to be sent with the AJAX request.\n\t */\n\t_publicMethods.updateFragments = function() {\n\t\t// Cancel existing update request\n\t\tif ( _xhr ) { _xhr.abort(); }\n\n\t\t// Get data to send\n\t\tvar data = FCUtils.extendObject( data, {\n\t\t\tsecurity:     _settings.updateFragmentsNonce,\n\t\t\tpost_data :   $( _settings.dataFormSelector ).serialize(),\n\t\t} );\n\n\t\t_xhr = $.ajax({\n\t\t\ttype:\t\t'POST',\n\t\t\turl:\t\tfcSettings.wcAjaxUrl.toString().replace( '%%endpoint%%', 'fc_update_fragments' ),\n\t\t\tdata:\t\tdata,\n\t\t\tsuccess:\tfunction( result ) {\n\n\t\t\t\t// Reload the page if requested\n\t\t\t\tif ( result && true === result.reload ) {\n\t\t\t\t\twindow.location.reload();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// CHANGE: Set variables for current focused element\n\t\t\t\tFCUtils.setCurrentFocusedElementGlobalVariables();\n\n\t\t\t\t// Always update the fragments\n\t\t\t\tif ( result && result.fragments ) {\n\n\t\t\t\t\t$.each( result.fragments, function ( key, value ) {\n\t\t\t\t\t\t// CHANGE: Declare local variables needed for some checks before replacing the fragment\n\t\t\t\t\t\tvar fragmentToReplace = document.querySelector( key );\n\t\t\t\t\t\tvar replaceFragment = true;\n\n\t\t\t\t\t\t// CHANGE: Allow fragments to be replaced every time even when their contents are equal the existing elements in the DOM\n\t\t\t\t\t\tif ( value && -1 !== value.toString().indexOf( 'fc-fragment-always-replace' ) ) {\n\t\t\t\t\t\t\treplaceFragment = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t// CHANGE: Allow fragments to be replaced every time even when their contents are equal the existing elements in the DOM\n\t\t\t\t\t\tif ( replaceFragment && ( ! _fragments || _fragments[ key ] !== value ) ) {\n\t\t\t\t\t\t\t// CHANGE: Log replaced fragment to console if debug mode is enabled.\n\t\t\t\t\t\t\tif ( fcSettings.debugMode ) {\n\t\t\t\t\t\t\t\tconsole.log( 'Replacing fragment: ' + key );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$( key ).replaceWith( value );\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$( key ).unblock();\n\t\t\t\t\t} );\n\t\t\t\t\t_fragments = result.fragments;\n\t\t\t\t}\n\n\t\t\t\t// CHANGE: Re-set focus to the element with focus previously to updating fragments\n\t\t\t\tFCUtils.maybeRefocusElement( window.fcCurrentFocusedElement, window.fcCurrentFocusedElementValue );\n\n\t\t\t\t// Maybe remove loading class from form rows when completing the ajax request\n\t\t\t\tmaybeStopLoadingIndicators();\n\n\t\t\t\t// Maybe scroll to notices\n\t\t\t\tvar messagesWrapper = document.querySelector( _settings.messagesWrapperSelector );\n\t\t\t\tif ( messagesWrapper && messagesWrapper.children.length > 0 && window.FCUtils && 'function' === typeof FCUtils.scrollToElement ) {\n\t\t\t\t\tFCUtils.scrollToElement( messagesWrapper );\n\t\t\t\t}\n\n\t\t\t\t$( document.body ).trigger( 'fc_fragments_refreshed' );\n\t\t\t}\n\n\t\t});\n\t};\n\n\t\n\n\t/**\n\t * Use the same method that WooCommerce uses to block other parts of the checkout form while updating.\n\t * The UI is unblocked by the WooCommerce `checkout.js` script (which is replaced with a modified version but keeps the same behavior)\n\t * using the checkout fragment selector, then unblocking after the checkout update is completed.\n\t *\n\t * @param   HTMLElement  element  Element to block the UI and show the loading indicator.\n\t */\n\t_publicMethods.blockUI = function( element ) {\n\t\t$( element ).addClass( _settings.uiProcessingClass ).block( {\n\t\t\tmessage: null,\n\t\t\toverlayCSS: {\n\t\t\t\tbackground: '#fff',\n\t\t\t\topacity: 0.6\n\t\t\t}\n\t\t} );\n\t}\n\n\t/**\n\t * Unblock UI element to be used again.\n\t *\n\t * @param   HTMLElement  element  Element to get the UI unblocked.\n\t *\n\t * @see  blockUI\n\t */\n\t_publicMethods.unblockUI = function( element ) {\n\t\t$( element ).removeClass( _settings.uiProcessingClass ).unblock();\n\t}\n\n\n\n\t/**\n\t * Handle form field change event and route to the appropriate function.\n\t */\n\tvar handleChange = function( e ) {\n\t\t// LOADING INDICATOR\n\t\tmaybeSetLoadingIndicator( e );\n\n\t\t// UPDATE ON CHANGE\n\t\tif ( e.target.matches( _settings.updateFieldsSelector ) ) {\n\t\t\t_debouncedUpdateFragments();\n\t\t}\n\t};\n\n\t/**\n\t * Handle keypress event.\n\t */\n\tvar handleKeyDown = function( e ) {\n\t\t// Should do nothing if the default action has been cancelled\n\t\tif ( e.defaultPrevented ) { return; }\n\n\t\t// Bail if control keys pressed\n\t\tif (\n\t\t\tFCUtils.keyboardKeys.ESC === e.key\n\t\t\t|| FCUtils.keyboardKeys.ENTER === e.key\n\t\t\t|| FCUtils.keyboardKeys.TAB === e.key\n\t\t\t|| FCUtils.keyboardKeys.CAPS === e.key\n\t\t\t|| FCUtils.keyboardKeys.SHIFT === e.key\n\t\t\t|| FCUtils.keyboardKeys.FUNCTION === e.key\n\t\t\t|| FCUtils.keyboardKeys.CONTROL === e.key\n\t\t\t|| FCUtils.keyboardKeys.COMMAND_OR_WINDOWS === e.key\n\t\t\t|| FCUtils.keyboardKeys.ALT === e.key\n\t\t\t|| FCUtils.keyboardKeys.ARROW_LEFT === e.key\n\t\t\t|| FCUtils.keyboardKeys.ARROW_RIGHT === e.key\n\t\t\t|| FCUtils.keyboardKeys.ARROW_UP === e.key\n\t\t\t|| FCUtils.keyboardKeys.ARROW_DOWN === e.key\n\t\t) { return; }\n\n\t\t// LOADING INDICATOR\n\t\tmaybeSetLoadingIndicator( e );\n\n\t\t// UPDATE ON CHANGE\n\t\tif ( e.target.matches( _settings.updateFieldsSelector ) ) {\n\t\t\t_debouncedUpdateFragments();\n\t\t}\n\t}\n\n\n\n\t/**\n\t * Initialize component and set related handlers.\n\t */\n\t_publicMethods.init = function( options ) {\n\t\tif ( _hasInitialized ) return;\n\n\t\t// Merge settings\n\t\t_settings = FCUtils.extendObject( _settings, options );\n\n\t\t// Set debounced update fragments function\n\t\t_debouncedUpdateFragments = FCUtils.debounce( _publicMethods.updateFragments, _settings.updateWaitTime );\n\n\t\t// Add jQuery event listeners\n\t\tif ( _hasJQuery ) {\n\t\t\t// Refresh triggers\n\t\t\t$( document.body ).on( 'fc_fragment_refresh', _debouncedUpdateFragments );\n\n\t\t\t// After fragments has been updated\n\t\t\t$( document.body ).on( 'fc_fragments_refreshed', maybeChangeSectionState );\n\t\t\t$( document.body ).on( 'fc_fragments_refreshed', maybeEnhanceFields );\n\t\t}\n\n\t\t// Refresh triggers\n\t\twindow.addEventListener( 'change', handleChange );\n\t\tdocument.addEventListener( 'keydown', handleKeyDown, true );\n\n\t\t// Add init class\n\t\tdocument.body.classList.add( _settings.bodyClass );\n\n\t\t_hasInitialized = true;\n\t};\n\n\n\n\t//\n\t// Public APIs\n\t//\n\treturn _publicMethods;\n\n});\n"],"names":["root","factory","define","amd","exports","module","FCFragmentsRefresh","global","this","window","maybeChangeSectionState","_event","data","sectionElements","document","querySelectorAll","_settings","sectionSelector","i","length","sectionElement","visibilityHiddenField","querySelector","sectionVisibleStateFieldSelector","value","setAttribute","sectionVisibleStateAttribute","removeAttribute","maybeEnhanceFields","FCEnhancedSelect","enhanceFields","maybeSetLoadingIndicator","e","target","matches","loadingInputSelector","formRow","closest","formRowSelector","classList","add","loadingClass","handleChange","updateFieldsSelector","_debouncedUpdateFragments","handleKeyDown","defaultPrevented","FCUtils","keyboardKeys","ESC","key","ENTER","TAB","CAPS","SHIFT","FUNCTION","CONTROL","COMMAND_OR_WINDOWS","ALT","ARROW_LEFT","ARROW_RIGHT","ARROW_UP","ARROW_DOWN","$","jQuery","_hasJQuery","_hasInitialized","_publicMethods","bodyClass","dataFormSelector","messagesWrapperSelector","uiProcessingClass","updateFragmentsNonce","updateWaitTime","_xhr","_fragments","updateFragments","abort","extendObject","security","post_data","serialize","ajax","type","url","fcSettings","wcAjaxUrl","toString","replace","success","result","reload","location","setCurrentFocusedElementGlobalVariables","fragments","each","replaceFragment","indexOf","debugMode","console","log","replaceWith","unblock","maybeRefocusElement","fcCurrentFocusedElement","fcCurrentFocusedElementValue","maybeLoadingFields","remove","messagesWrapper","children","scrollToElement","body","trigger","blockUI","element","addClass","block","message","overlayCSS","background","opacity","unblockUI","removeClass","init","options","debounce","on","addEventListener"],"mappings":"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"}